name: Issue Version Check

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  version-check:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'bug')
    steps:
      - name: Check reported version against latest release
        uses: actions/github-script@v7
        with:
          script: |
            const normalize = v => v.trim().replace(/^v/i, '');

            const ensureLabel = async (name, color, description) => {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name,
                  color,
                  description,
                });
              } catch {
                // Label already exists — ignore
              }
            };

            const body = context.payload.issue.body || '';
            const issueNumber = context.payload.issue.number;
            const existingLabels = context.payload.issue.labels.map(l => l.name);

            // Extract reported version from issue body
            const versionMatch = body.match(/### Release Version\s*\n+([^\n#]+)/i);
            if (!versionMatch) return;
            const reportedVersion = normalize(versionMatch[1]);
            if (!reportedVersion) return;

            // Skip if already labeled
            if (existingLabels.includes('outdated-version')) return;

            // Get latest release
            let latestRelease;
            try {
              const { data } = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              latestRelease = data;
            } catch {
              // No releases yet — nothing to compare against
              return;
            }

            const latestVersion = normalize(latestRelease.tag_name);

            if (reportedVersion === latestVersion) return;

            await ensureLabel('outdated-version', 'e4e669', 'Issue reported on an outdated version');
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['outdated-version'],
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                'Thanks for the report.',
                '',
                `You are running version **${reportedVersion}**, but the latest release of Krisinformation is **${latestVersion}**.`,
                '',
                'Please update to the latest version and check whether the issue still occurs.',
                '',
                'If the issue persists after updating, please comment here and we will continue investigating.',
                'If we do not hear back within 24 hours, this issue will be automatically closed.',
              ].join('\n'),
            });
